// description: AveMaria network indicators for 20230918
let payloadURLs = external_data(payloadURL: string) [h"https://raw.githubusercontent.com/reversinglabs/reversinglabs-siem-rules/master/Malware/AveMaria/20230918/KQL/avemaria-20230918-payloadurls.txt"];
let c2domains = external_data(c2domain: string) [h"https://raw.githubusercontent.com/reversinglabs/reversinglabs-siem-rules/master/Malware/AveMaria/20230918/KQL/avemaria-20230918-c2domains.txt"];
let c2ips = external_data(c2ip: string) [h"https://raw.githubusercontent.com/reversinglabs/reversinglabs-siem-rules/master/Malware/AveMaria/20230918/KQL/avemaria-20230918-c2ips.txt"];
CommonSecurityLog
| where DestinationHostName in (c2domains) or DestinationIP in (c2ips) or RequestURL in (payloadURLs)
| union 
(DeviceNetworkEvents
| where RemoteUrl in (payloadURLs) or RemoteIP in (c2ips)
),
(SysmonParser
| where (EventID == 3 and DestinationIp in (c2ips)) 
or (EventID == 22 and QueryName in (c2domains))
)