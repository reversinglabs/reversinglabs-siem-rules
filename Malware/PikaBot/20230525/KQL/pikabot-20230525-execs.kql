// description: PikaBot process execution seen for week of 2023-05-25
let EncodedKeywords = dynamic(['-encodedcommand', '-enc']);
let DecodedCommands = dynamic([
  "start rundll32 $env:ProgramData\\neighbourer.OutmarchesBisinuate,vips;slack.com", 
  "start rundll32 $env:ProgramData\\trichoglossidae.Symphily,vips;MITLicense", 
  "start rundll32 $env:TEMP\\amphibolostylous.grommets,Test;Expressjs", 
  "start rundll32 C:\\ProgramData\\reknowMechant.montageFirring,DllRegisterServer;Angular"]);
SecurityEvent
  | where EventID == 4688
  | where ProcessName == "wscript.exe" and CommandLine matches regex @"C:\\Users\\.*\\AppData\\Local\\Temp\\.*\.js"
| union (SecurityEvent
  | where EventID == 4688
    | where ProcessName contains "powershell"
    | where CommandLine has_any (EncodedKeywords)
    | extend EncodedCommand = extract(@'\s+([A-Za-z0-9+/]{20}\S+$)', 1, CommandLine)
    | extend DecodedCommand = base64_decode_tostring(EncodedCommand)
    | where not(isempty(EncodedCommand) and isempty(DecodedCommand))
    | where DecodedCommand has_any (DecodedCommands)
), 
(DeviceProcessEvents
  | where FileName == "wscript.exe" and ProcessCommandLine matches regex @"C:\\Users\\.*\\AppData\\Local\\Temp\\.*\.js"
),
(DeviceProcessEvents
  | where ProcessCommandLine contains "powershell" or InitiatingProcessCommandLine contains "powershell"
  | where ProcessCommandLine has_any (EncodedKeywords) or InitiatingProcessCommandLine has_any (EncodedKeywords)
  | extend EncodedCommand = extract(@'\s+([A-Za-z0-9+/]{20}\S+$)', 1, ProcessCommandLine)
  | extend DecodedCommand = base64_decode_tostring(EncodedCommand)
  | where not(isempty(EncodedCommand) and isempty(DecodedCommand))
  | where DecodedCommand has_any (DecodedCommands)
)