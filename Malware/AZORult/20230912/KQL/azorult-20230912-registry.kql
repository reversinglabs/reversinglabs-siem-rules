// this query identifies a potential registry key created by recent azorult samples
let KeyPath = @"\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows";
let DataValue = @"(?i)C:\\Users\\.*\\(snmptrap|InfDefaultInstall)\\(setupcl|SystemSettingsAdminFlows).exe";
SysmonParser
| where (EventID == 12 and TargetObject contains strcat(@"HKCU", KeyPath))
or (EventID == 13 and TargetObject contains strcat(@"HKCU", KeyPath, @"\Load") and Details matches regex DataValue)
| union (
DeviceRegistryEvents
| where (ActionType == "RegistryKeyCreated" and RegistryKey contains strcat(@"HKEY_CURRENT_USER", KeyPath))
 or (ActionType == "RegistryValueSet" and RegistryKey contains KeyPath and RegistryValueName == "Load" and RegistryValueData matches regex DataValue)
)